<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planner</title>
  <link rel="stylesheet" href="./styles.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png">

</head>
<body>
  <header class="topbar">
    <nav class="nav">
      <a href="./index.html">Dashboard</a>
      <a href="./savings.html">Savings</a>
      <a class="active" href="./planner.html">Planner</a>
    </nav>
  </header>

  <main class="container">
    <section class="card">
      <div class="row-between">
        <h1>Planner</h1>
        <button id="openTaskModal" class="btn">Add task</button>
      </div>
      <div id="calendar"></div>
    </section>

    <section class="card">
      <h2>Today</h2>
      <div id="todayTasks" class="list"></div>
    </section>
  </main>

  <!-- Modal -->
  <dialog id="taskModal" class="modal">
    <form id="taskForm" method="dialog" class="modal-body">
      <h3>Add task</h3>

      <label>
        Title
        <input name="title" required />
      </label>

      <label>
        Details
        <textarea name="details" rows="3" placeholder="Optional"></textarea>
      </label>

      <label>
        Start
        <input name="start" type="datetime-local" required />
      </label>

      <label>
        End (optional)
        <input name="end" type="datetime-local" />
      </label>

      <div class="modal-actions">
        <button type="button" class="btn secondary" id="closeTaskModal">Cancel</button>
        <button type="submit" class="btn">Save</button>
      </div>
    </form>
  </dialog>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
  <script src="./app.js"></script>
  <script>
    const taskModal = document.getElementById("taskModal");
    const openTaskModalBtn = document.getElementById("openTaskModal");
    const closeTaskModalBtn = document.getElementById("closeTaskModal");
    const taskForm = document.getElementById("taskForm");
    const todayTasksEl = document.getElementById("todayTasks");

    openTaskModalBtn.addEventListener("click", () => taskModal.showModal());
    closeTaskModalBtn.addEventListener("click", () => taskModal.close());

    function isSameDay(a, b) {
      return a.getFullYear() === b.getFullYear() &&
             a.getMonth() === b.getMonth() &&
             a.getDate() === b.getDate();
    }

    function renderTodayList() {
      const tasks = getTasks().sort((a,b) => new Date(a.start) - new Date(b.start));
      const today = new Date();

      const todayTasks = tasks.filter(t => isSameDay(new Date(t.start), today));
      todayTasksEl.innerHTML = todayTasks.map(t => `
        <label class="checkbox-row">
          <input type="checkbox" ${t.status === "done" ? "checked" : ""} data-id="${t.id}">
          <span class="${t.status === "done" ? "done" : ""}">
            ${escapeHtml(t.title)}
            <span class="muted small">(${new Date(t.start).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})})</span>
          </span>
        </label>
      `).join("") || `<div class="muted">No tasks scheduled for today.</div>`;

      todayTasksEl.querySelectorAll("input[type=checkbox]").forEach(cb => {
        cb.addEventListener("change", (e) => {
          const id = e.target.dataset.id;
          const tasksAll = getTasks();
          const idx = tasksAll.findIndex(x => x.id === id);
          if (idx >= 0) {
            tasksAll[idx].status = e.target.checked ? "done" : "open";
            tasksAll[idx].completedAt = e.target.checked ? new Date().toISOString() : null;
            saveTasks(tasksAll);
            calendar.refetchEvents();
            renderTodayList();
          }
        });
      });
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    const calendarEl = document.getElementById("calendar");
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay"
      },
      events: (info, success) => {
        const tasks = getTasks();
        const events = tasks.map(t => ({
          id: t.id,
          title: t.status === "done" ? `âœ” ${t.title}` : t.title,
          start: t.start,
          end: t.end || null,
          backgroundColor: undefined, // let default theme decide
          borderColor: undefined
        }));
        success(events);
      },
      eventClick: (arg) => {
        // quick toggle done/open on click
        const id = arg.event.id;
        const tasks = getTasks();
        const idx = tasks.findIndex(x => x.id === id);
        if (idx >= 0) {
          tasks[idx].status = tasks[idx].status === "done" ? "open" : "done";
          tasks[idx].completedAt = tasks[idx].status === "done" ? new Date().toISOString() : null;
          saveTasks(tasks);
          calendar.refetchEvents();
          renderTodayList();
        }
      }
    });

    calendar.render();

    taskForm.addEventListener("submit", () => {
      const data = new FormData(taskForm);
      const title = data.get("title");
      const details = data.get("details") || "";
      const start = new Date(data.get("start")).toISOString();
      const endRaw = data.get("end");
      const end = endRaw ? new Date(endRaw).toISOString() : "";

      const tasks = getTasks();
      tasks.push({
        id: uid("task"),
        title,
        details,
        start,
        end,
        status: "open",
        completedAt: null
      });
      saveTasks(tasks);

      taskForm.reset();
      taskModal.close();
      calendar.refetchEvents();
      renderTodayList();
    });

    renderTodayList();
  </script>
</body>
</html>

